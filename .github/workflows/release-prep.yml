name: Prepare release

on:
  push:
    branches:
      - "release/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Compute release version
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          token: ${{secrets.GITHUB_TOKEN}}
          persist-credentials: false

      - name: Parse release version from branch name
        id: version
        shell: bash
        run: |
          set -euo pipefail

          branch="${GITHUB_REF_NAME}"

          # Accepts:
          #   release/vX.Y.Z
          #   release/vX.Y.Z-rc.N
          regex='^release/v([0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?)$'

          if [[ "$branch" =~ $regex ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "version=${VERSION}" >>"$GITHUB_OUTPUT"
            if [[ "$VERSION" == *-rc* ]]; then
              echo "prerelease=true" >>"$GITHUB_OUTPUT"
            else
              echo "prerelease=false" >>"$GITHUB_OUTPUT"
            fi
          else
            echo "::error::branch '$branch' is not a valid release branch (expected release/vX.Y.Z or release/vX.Y.Z-rc.N)" >&2
            exit 1
          fi

      - name: Validate crate versions
        shell: bash
        run: |
          set -euo pipefail

          EXPECTED_VERSION="${{ steps.version.outputs.version }}"
          CRATES=(
            graft
            graft-sqlite
          )

          for crate in "${CRATES[@]}"; do
            CRATE_VERSION="$(cargo pkgid $crate | cut -d "#" -f2)"
            if [[ "$CRATE_VERSION" != "$EXPECTED_VERSION" ]]; then
              echo "::error::crate '$crate' version '$CRATE_VERSION' does not match expected version '$EXPECTED_VERSION'" >&2
              exit 1
            fi
          done

  crates:
    name: Verify crates
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: system dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: clang libclang-dev llvm mold libncurses-dev build-essential libreadline-dev
          version: 1.0

      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          components: clippy, rustfmt

      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          token: ${{secrets.GITHUB_TOKEN}}
          persist-credentials: false

      - name: Build
        run: cargo build --release

  build:
    strategy:
      matrix:
        platform:
          - runs-on: ubuntu-24.04
            features: dynamic
            targets:
              - x86_64-unknown-linux-gnu
              - aarch64-unknown-linux-gnu
            artifact-name: dynamic-linux
            artifacts: |
              target/x86_64-unknown-linux-gnu/release/libgraft_ext.so
              target/aarch64-unknown-linux-gnu/release/libgraft_ext.so

          - runs-on: windows-2022
            features: dynamic
            targets:
              - x86_64-pc-windows-msvc
              - aarch64-pc-windows-msvc
            artifact-name: dynamic-windows
            artifacts: |
              target/x86_64-pc-windows-msvc/release/graft_ext.dll
              target/aarch64-pc-windows-msvc/release/graft_ext.dll

          - runs-on: macos-14
            features: dynamic
            targets:
              - x86_64-apple-darwin
              - aarch64-apple-darwin
            artifact-name: dynamic-macos
            artifacts: |
              target/x86_64-apple-darwin/release/libgraft_ext.dylib
              target/aarch64-apple-darwin/release/libgraft_ext.dylib

          - runs-on: macos-14
            features: static
            targets:
              - aarch64-apple-ios
              - aarch64-apple-ios-sim
            artifact-name: static-ios
            artifacts: |
              target/aarch64-apple-ios/release/libgraft_ext.a
              target/aarch64-apple-ios-sim/release/libgraft_ext.a

    name: Building ${{ matrix.platform.artifact-name }} artifact
    runs-on: ${{ matrix.platform.runs-on }}
    permissions:
      contents: read

    defaults:
      run:
        shell: bash

    steps:
      - name: system dependencies
        if: startsWith(matrix.platform.runs-on, 'ubuntu')
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: mold libclang-dev clang gcc-aarch64-linux-gnu
          version: 1.0

      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          targets: ${{ join(matrix.platform.targets, ',') }}

      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          token: ${{secrets.GITHUB_TOKEN}}
          persist-credentials: false

      - name: Pre-build osx
        if: startsWith(matrix.platform.runs-on, 'macos')
        run: |
          set -euo pipefail
          echo "LIBCLANG_PATH=$(brew --prefix llvm@15)/lib" >> $GITHUB_ENV

      - name: Static Rustflags
        if: matrix.platform.features == 'static'
        run: |
          set -euo pipefail
          echo "RUSTFLAGS=-C link-arg=-Wl,-undefined,dynamic_lookup" >> $GITHUB_ENV

      - name: Build the extension
        run: |
          for target in ${{ join(matrix.platform.targets, ' ') }}; do
            cargo build --release \
              --no-default-features \
              --features precept/disabled,${{ matrix.platform.features }} \
              --package graft-ext \
              --target $target
          done

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ matrix.platform.artifact-name }}
          path: ${{ matrix.platform.artifacts }}
          if-no-files-found: error
          retention-days: 3

  build-ios-universal:
    runs-on: macos-15
    needs: [build]
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          token: ${{secrets.GITHUB_TOKEN}}
          persist-credentials: false

      - name: Download artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: static-ios
          path: input/

      - name: build ios universal library
        run: |
          set -euo pipefail
          xcodebuild -create-xcframework \
            -library input/aarch64-apple-ios/release/libgraft_ext.a \
            -headers crates/graft-ext/include \
            -library input/aarch64-apple-ios-sim/release/libgraft_ext.a \
            -headers crates/graft-ext/include \
            -output libgraft_ext.xcframework

      - name: Upload universal library artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: libgraft_ext.xcframework
          path: libgraft_ext.xcframework

  package:
    runs-on: ubuntu-24.04
    needs: [build, build-ios-universal, validate, crates]

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          token: ${{secrets.GITHUB_TOKEN}}
          persist-credentials: false

      - name: system dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: tree
          version: 1.0

      - name: Install just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Install sqlite-dist
        run: |
          # curl -L https://github.com/asg017/sqlite-dist/releases/download/v0.0.1-alpha.17/sqlite-dist-x86_64-unknown-linux-gnu.tar.xz \
          #   | tar xfJ - --strip-components 1 sqlite-dist-x86_64-unknown-linux-gnu/sqlite-dist
          curl -L https://github.com/carlsverre/sqlite-dist/releases/download/v0.1.0-prerelease.1/sqlite-dist > sqlite-dist
          chmod +x sqlite-dist

      - name: Download dynamic artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          pattern: dynamic-*
          path: builds/
          merge-multiple: true

      - name: Reorganize build artifacts
        run: |
          mkdir -p dist/{linux,windows,macos}-{x86_64,aarch64}
          mv builds/x86_64-unknown-linux-gnu/release/libgraft_ext.so     dist/linux-x86_64/libgraft_ext.so
          mv builds/aarch64-unknown-linux-gnu/release/libgraft_ext.so    dist/linux-aarch64/libgraft_ext.so
          mv builds/x86_64-pc-windows-msvc/release/graft_ext.dll         dist/windows-x86_64/graft_ext.dll
          mv builds/aarch64-pc-windows-msvc/release/graft_ext.dll        dist/windows-aarch64/graft_ext.dll
          mv builds/x86_64-apple-darwin/release/libgraft_ext.dylib       dist/macos-x86_64/libgraft_ext.dylib
          mv builds/aarch64-apple-darwin/release/libgraft_ext.dylib      dist/macos-aarch64/libgraft_ext.dylib

      - name: Run SQLite dist
        run: |
          VERSION=${{ needs.validate.outputs.version }}
          ./sqlite-dist ./sqlite-dist.toml --input dist/ --output distx/ --version ${VERSION}

      - name: Download ios-universal libgraft_ext.xcframework artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: libgraft_ext.xcframework
          path: dist/libgraft_ext.xcframework

      - name: Package archives
        run: just run package-archives

      - name: Add metadata to distx
        run: |
          echo "${{ needs.validate.outputs.version }}" > distx/version

      - name: Print distribution tree
        run: tree distx/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          name: v${{ needs.validate.outputs.version }}
          tag_name: v${{ needs.validate.outputs.version }}
          prerelease: ${{ needs.validate.outputs.prerelease }}
          make_latest: ${{ needs.validate.outputs.prerelease == 'false' }}
          draft: true
          generate_release_notes: true
          fail_on_unmatched_files: true
          files: distx/archives/*

      - name: Upload distx
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: distx
          path: distx/
          retention-days: 3
