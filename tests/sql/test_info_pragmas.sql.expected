-- initialize two connections to the same database
.connection 0
.open "file:main?vfs=graft"
pragma graft_switch="74ggc1B6R4-2kkvcy9fi4CHJ:74ggc1B6jg-2udz14pbDayZC";
+-------------------------------------------------------------------------------------+
| Switched to Graft 74ggc1B6R4-2kkvcy9fi4CHJ with remote Log 74ggc1B6jg-2udz14pbDayZC |
+-------------------------------------------------------------------------------------+
| Switched to Graft 74ggc1B6R4-2kkvcy9fi4CHJ with remote Log 74ggc1B6jg-2udz14pbDayZC |
+-------------------------------------------------------------------------------------+
pragma graft_status;
+------------------------------------------------------+
|                     On tag main                      |
+------------------------------------------------------+
| On tag main                                          |
| Local Log 74ggc1B6R4-2kkvcy9fi4CHJ (_) is grafted to |
| remote Log 74ggc1B6jg-2udz14pbDayZC (_).             |
|                                                      |
| The local Log is up to date with the remote Log.     |
+------------------------------------------------------+
pragma graft_info;
+----------------------------------+
| Graft: 74ggc1B6R4-2kkvcy9fi4CHJ  |
+----------------------------------+
| Graft: 74ggc1B6R4-2kkvcy9fi4CHJ  |
| Remote: 74ggc1B6jg-2udz14pbDayZC |
| Last sync: Never synced          |
| Snapshot: Snapshot([])           |
| Snapshot pages: 0                |
| Snapshot size: 0 B               |
+----------------------------------+

.connection 1
.open "file:main?vfs=graft"
pragma graft_status;
+------------------------------------------------------+
|                     On tag main                      |
+------------------------------------------------------+
| On tag main                                          |
| Local Log 74ggc1B6R4-2kkvcy9fi4CHJ (_) is grafted to |
| remote Log 74ggc1B6jg-2udz14pbDayZC (_).             |
|                                                      |
| The local Log is up to date with the remote Log.     |
+------------------------------------------------------+
pragma graft_info;
+----------------------------------+
| Graft: 74ggc1B6R4-2kkvcy9fi4CHJ  |
+----------------------------------+
| Graft: 74ggc1B6R4-2kkvcy9fi4CHJ  |
| Remote: 74ggc1B6jg-2udz14pbDayZC |
| Last sync: Never synced          |
| Snapshot: Snapshot([])           |
| Snapshot pages: 0                |
| Snapshot size: 0 B               |
+----------------------------------+

-- initialize the db on connection 0
.connection 0
.echo off

-- check pragmas
pragma graft_status;
+------------------------------------------------------+
|                     On tag main                      |
+------------------------------------------------------+
| On tag main                                          |
| Local Log 74ggc1B6R4-2kkvcy9fi4CHJ (6) is grafted to |
| remote Log 74ggc1B6jg-2udz14pbDayZC (_).             |
|                                                      |
| The local Log is 6 commits ahead of the remote Log.  |
|   (use 'pragma graft_push' to push changes)          |
+------------------------------------------------------+
pragma graft_snapshot;
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=6]]) |
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=6]]) |
+---------------------------------+
pragma graft_audit;
+--------------------------------------------------------+
|   Cached 14 of 14 pages (100%) from the remote Log.    |
+--------------------------------------------------------+
| Cached 14 of 14 pages (100%) from the remote Log.      |
| Checksum: 2FpLPEqwTAbQR14Bp84n8NHYPN94RnhnXo6u63js1SSV |
+--------------------------------------------------------+
pragma graft_info;
+-------------------------------------------+
|      Graft: 74ggc1B6R4-2kkvcy9fi4CHJ      |
+-------------------------------------------+
| Graft: 74ggc1B6R4-2kkvcy9fi4CHJ           |
| Remote: 74ggc1B6jg-2udz14pbDayZC          |
| Last sync: Never synced                   |
| Snapshot: Snapshot([2kkvcy9fi4CHJ[..=6]]) |
| Snapshot pages: 14                        |
| Snapshot size: 56 KB                      |
+-------------------------------------------+

-- check pragmas on connection 1
.connection 1
pragma graft_status;
+------------------------------------------------------+
|                     On tag main                      |
+------------------------------------------------------+
| On tag main                                          |
| Local Log 74ggc1B6R4-2kkvcy9fi4CHJ (6) is grafted to |
| remote Log 74ggc1B6jg-2udz14pbDayZC (_).             |
|                                                      |
| The local Log is 6 commits ahead of the remote Log.  |
|   (use 'pragma graft_push' to push changes)          |
+------------------------------------------------------+
pragma graft_snapshot;
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=6]]) |
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=6]]) |
+---------------------------------+
pragma graft_audit;
+--------------------------------------------------------+
|   Cached 14 of 14 pages (100%) from the remote Log.    |
+--------------------------------------------------------+
| Cached 14 of 14 pages (100%) from the remote Log.      |
| Checksum: 2FpLPEqwTAbQR14Bp84n8NHYPN94RnhnXo6u63js1SSV |
+--------------------------------------------------------+
pragma graft_info;
+-------------------------------------------+
|      Graft: 74ggc1B6R4-2kkvcy9fi4CHJ      |
+-------------------------------------------+
| Graft: 74ggc1B6R4-2kkvcy9fi4CHJ           |
| Remote: 74ggc1B6jg-2udz14pbDayZC          |
| Last sync: Never synced                   |
| Snapshot: Snapshot([2kkvcy9fi4CHJ[..=6]]) |
| Snapshot pages: 14                        |
| Snapshot size: 56 KB                      |
+-------------------------------------------+

-- open a snapshot on connection 1
begin;
select count(*) from ledger;
+----------+
| count(*) |
+----------+
| 1000     |
+----------+
pragma graft_snapshot;
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=6]]) |
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=6]]) |
+---------------------------------+

-- switch to connection 0, write something, check snapshot, switch back
.connection 0
INSERT INTO ledger (account_id, amount) VALUES (1, -10), (2, 10);
pragma graft_snapshot;
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=7]]) |
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=7]]) |
+---------------------------------+
.connection 1

-- check that connection 1 pragmas can't see the new snapshot
pragma graft_snapshot;
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=6]]) |
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=6]]) |
+---------------------------------+
pragma graft_audit;
+--------------------------------------------------------+
|   Cached 14 of 14 pages (100%) from the remote Log.    |
+--------------------------------------------------------+
| Cached 14 of 14 pages (100%) from the remote Log.      |
| Checksum: 2FpLPEqwTAbQR14Bp84n8NHYPN94RnhnXo6u63js1SSV |
+--------------------------------------------------------+
pragma graft_info;
+-------------------------------------------+
|      Graft: 74ggc1B6R4-2kkvcy9fi4CHJ      |
+-------------------------------------------+
| Graft: 74ggc1B6R4-2kkvcy9fi4CHJ           |
| Remote: 74ggc1B6jg-2udz14pbDayZC          |
| Last sync: Never synced                   |
| Snapshot: Snapshot([2kkvcy9fi4CHJ[..=6]]) |
| Snapshot pages: 14                        |
| Snapshot size: 56 KB                      |
+-------------------------------------------+

-- close the snapshot and check that we can see the latest snapshot
commit;

pragma graft_snapshot;
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=7]]) |
+---------------------------------+
| Snapshot([2kkvcy9fi4CHJ[..=7]]) |
+---------------------------------+
pragma graft_audit;
+--------------------------------------------------------+
|   Cached 14 of 14 pages (100%) from the remote Log.    |
+--------------------------------------------------------+
| Cached 14 of 14 pages (100%) from the remote Log.      |
| Checksum: BKmJp5EaFm8LVjNqMhYffRkzztBphJ6vb9dYfannr3DY |
+--------------------------------------------------------+
pragma graft_info;
+-------------------------------------------+
|      Graft: 74ggc1B6R4-2kkvcy9fi4CHJ      |
+-------------------------------------------+
| Graft: 74ggc1B6R4-2kkvcy9fi4CHJ           |
| Remote: 74ggc1B6jg-2udz14pbDayZC          |
| Last sync: Never synced                   |
| Snapshot: Snapshot([2kkvcy9fi4CHJ[..=7]]) |
| Snapshot pages: 14                        |
| Snapshot size: 56 KB                      |
+-------------------------------------------+

SQLite Exit Code = 0
